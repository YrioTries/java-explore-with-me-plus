{
  "info": {
    "name": "EWM Reviews — New Tests",
    "_postman_id": "b77a3f2e-4d8f-4a55-a1b2-new-reviews",
    "description": "Новая коллекция: стабильные тесты для отзывов (private/public/admin) по коду контроллеров и сервисов.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": { "type": "noauth" },
  "item": [
    {
      "name": "00 Sanity",
      "item": [
        {
          "name": "Healthcheck",
          "request": { "method": "GET", "header": [], "url": "{{baseUrl}}/actuator/health" },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200/UP', () => pm.expect(pm.response.code).to.be.oneOf());",
                  "const j = pm.response.json?.() || {}; pm.test('status=UP', () => pm.expect(j.status).to.equal('UP'));"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "10 Private",
      "description": "Действия автора: создать, прочитать, обновить, удалить",
      "item": [
        {
          "name": "Create review",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "{{userToken}}", "type": "text" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": "{{baseUrl}}/users/{{userIdAuthor}}/events/{{eventIdPublished}}/reviews",
            "body": {
              "mode": "raw",
              "raw": "{\n \"text\": \"Отзыв: организация на уровне, спасибо!\"\n}",
              "options": { "raw": { "language": "json" } }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('201/200', () => pm.expect(pm.response.code).to.be.oneOf());",
                  "let ok=true; try { pm.response.json(); } catch(e) { ok=false; }",
                  "pm.test('JSON body', () => pm.expect(ok).to.eql(true));",
                  "const r = pm.response.json?.() || {};",
                  "pm.test('has id/text/authorId/eventId', () => { ['id','text','authorId','eventId'].forEach(k=>pm.expect(r).to.have.property(k)); });",
                  "pm.environment.set('reviewId', r.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Get my review by id",
          "request": {
            "method": "GET",
            "header": [ { "key": "Authorization", "value": "{{userToken}}", "type": "text" } ],
            "url": "{{baseUrl}}/users/{{userIdAuthor}}/reviews/{{reviewId}}"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200', () => pm.response.to.have.status(200));",
                  "const r = pm.response.json?.() || {};",
                  "pm.test('ids match', () => { pm.expect(r.id).to.eql(Number(pm.environment.get('reviewId'))); pm.expect(r.authorId).to.eql(Number(pm.environment.get('userIdAuthor'))); });"
                ]
              }
            }
          ]
        },
        {
          "name": "Update text",
          "request": {
            "method": "PATCH",
            "header": [
              { "key": "Authorization", "value": "{{userToken}}", "type": "text" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": "{{baseUrl}}/users/{{userIdAuthor}}/reviews/{{reviewId}}",
            "body": {
              "mode": "raw",
              "raw": "{\n \"text\": \"Апдейт: понравилась площадка и тайминг.\"\n}",
              "options": { "raw": { "language": "json" } }
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200', () => pm.response.to.have.status(200));",
                  "const r = pm.response.json?.() || {}; pm.test('has text', () => pm.expect(r).to.have.property('text'));"
                ]
              }
            }
          ]
        },
        {
          "name": "Get all my reviews",
          "request": {
            "method": "GET",
            "header": [ { "key": "Authorization", "value": "{{userToken}}", "type": "text" } ],
            "url": "{{baseUrl}}/users/{{userIdAuthor}}/reviews"
          },
          "event": [
            {
              "listen": "test",
              "script": { "type": "text/javascript", "exec": [ "pm.test('200', () => pm.response.to.have.status(200));", "const arr = pm.response.json?.() || []; pm.test('array', () => pm.expect(arr).to.be.an('array'));" ] }
            }
          ]
        },
        {
          "name": "Delete my review",
          "request": {
            "method": "DELETE",
            "header": [ { "key": "Authorization", "value": "{{userToken}}", "type": "text" } ],
            "url": "{{baseUrl}}/users/{{userIdAuthor}}/reviews/{{reviewId}}"
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('204/200', () => pm.expect(pm.response.code).to.be.oneOf());" ] } }
          ]
        },
        {
          "name": "Get deleted (expect 404)",
          "request": {
            "method": "GET",
            "header": [ { "key": "Authorization", "value": "{{userToken}}", "type": "text" } ],
            "url": "{{baseUrl}}/users/{{userIdAuthor}}/reviews/{{reviewId}}"
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('404', () => pm.response.to.have.status(404));" ] } }
          ]
        }
      ]
    },
    {
      "name": "20 Public",
      "description": "Публичные отзывы события",
      "item": [
        {
          "name": "List event reviews paged",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/events/{{eventIdPublished}}/reviews?from={{pageFrom}}&size={{pageSize}}",
              "host": [ "{{baseUrl}}" ],
              "path": [ "events", "{{eventIdPublished}}", "reviews" ],
              "query": [
                { "key": "from", "value": "{{pageFrom}}" },
                { "key": "size", "value": "{{pageSize}}" }
              ]
            }
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('200', () => pm.response.to.have.status(200));", "pm.test('array', () => pm.expect(pm.response.json()).to.be.an('array'));" ] } }
          ]
        },
        {
          "name": "Invalid paging",
          "request": {
            "method": "GET",
            "header": [],
            "url": "{{baseUrl}}/events/{{eventIdPublished}}/reviews?from=-1&size=0"
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('400/422', () => pm.expect(pm.response.code).to.be.oneOf());" ] } }
          ]
        }
      ]
    },
    {
      "name": "30 Admin",
      "description": "Поиск/удаление админом",
      "item": [
        {
          "name": "Admin search by filters",
          "request": {
            "method": "GET",
            "header": [ { "key": "Authorization", "value": "{{adminToken}}", "type": "text" } ],
            "url": {
              "raw": "{{baseUrl}}/admin/reviews?text=ивент&users={{userIdAuthor}}&events={{eventIdPublished}}&from={{pageFrom}}&size={{pageSize}}",
              "host": [ "{{baseUrl}}" ],
              "path": [ "admin", "reviews" ],
              "query": [
                { "key": "text", "value": "ивент" },
                { "key": "users", "value": "{{userIdAuthor}}" },
                { "key": "events", "value": "{{eventIdPublished}}" },
                { "key": "from", "value": "{{pageFrom}}" },
                { "key": "size", "value": "{{pageSize}}" }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('200', () => pm.response.to.have.status(200));",
                  "const arr = pm.response.json?.() || []; pm.test('array', () => pm.expect(arr).to.be.an('array'));",
                  "if (Array.isArray(arr) && arr.length > 0) pm.environment.set('adminReviewIdToDelete', arr.id);"
                ]
              }
            }
          ]
        },
        {
          "name": "Admin delete by id",
          "request": {
            "method": "DELETE",
            "header": [ { "key": "Authorization", "value": "{{adminToken}}", "type": "text" } ],
            "url": "{{baseUrl}}/admin/reviews/{{adminReviewIdToDelete}}"
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('204/200', () => pm.expect(pm.response.code).to.be.oneOf());" ] } }
          ]
        },
        {
          "name": "Admin invalid paging",
          "request": {
            "method": "GET",
            "header": [ { "key": "Authorization", "value": "{{adminToken}}", "type": "text" } ],
            "url": "{{baseUrl}}/admin/reviews?from=-5&size=0"
          },
          "event": [
            { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('400/422', () => pm.expect(pm.response.code).to.be.oneOf());" ] } }
          ]
        }
      ]
    },
    {
      "name": "40 Business Rules (negatives)",
      "description": "Проверка verifyReview",
      "item": [
        {
          "name": "Before event ended (409)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "{{userToken}}", "type": "text" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": "{{baseUrl}}/users/{{userIdAuthor}}/events/{{eventIdPublished}}/reviews",
            "body": { "mode": "raw", "raw": "{\n \"text\": \"Рано оставлять отзыв\"\n}", "options": { "raw": { "language": "json" } } }
          },
          "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('409', () => pm.response.to.have.status(409));" ] } } ]
        },
        {
          "name": "Initiator cannot review (409)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "{{userToken}}", "type": "text" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": "{{baseUrl}}/users/{{userIdAuthor}}/events/{{eventIdPublished}}/reviews",
            "body": { "mode": "raw", "raw": "{\n \"text\": \"Инициатор не может\"\n}", "options": { "raw": { "language": "json" } } }
          },
          "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('409', () => pm.response.to.have.status(409));" ] } } ]
        },
        {
          "name": "No confirmed request (409/404)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Authorization", "value": "{{userToken}}", "type": "text" },
              { "key": "Content-Type", "value": "application/json" }
            ],
            "url": "{{baseUrl}}/users/{{userIdAuthor}}/events/{{eventIdPublished}}/reviews",
            "body": { "mode": "raw", "raw": "{\n \"text\": \"Нет подтверждения участия\"\n}", "options": { "raw": { "language": "json" } } }
          },
          "event": [ { "listen": "test", "script": { "type": "text/javascript", "exec": [ "pm.test('409/404', () => pm.expect(pm.response.code).to.be.oneOf());" ] } } ]
        }
      ]
    }
  ]
}